---
- name: Search and apply Windows Updates on EC2 Windows hosts
  hosts: win22
  gather_facts: no

  vars:
    
    update_categories:
      - SecurityUpdates
      - CriticalUpdates
      - UpdateRollups
      - Updates
      - Application
      - Connectors
      - Critical Updates
      - Definition Updates
      - Developer Kits
      - Feature Packs
      - Guidance
      - Security Updates
      - Service Packs
      - Tools
      - Update Rollups
      - Updates
      - Upgrades

    win_updates_log_path: 'C:\Windows\Temp\ansible_win_updates.log'
    install_passes: 3
    skip_reboot: false

  # pre_tasks:
  #   - name: Ensure this is Windows
  #     ansible.builtin.assert:
  #       that: ansible_os_family is not defined or ansible_os_family == 'Windows'
  #       fail_msg: "This playbook targets Windows only."

  #   - name: Display target host and connection info
  #     ansible.builtin.debug:
  #       msg:
  #         - "Host: {{ inventory_hostname }}"
  #         - "Connecting via WinRM. Ensure SG allows 5986/tcp and WinRM is configured."

  tasks:
    - name: Search for available updates (no install)
      ansible.windows.win_updates:
        state: searched
        category_names: "{{ update_categories }}"
      register: search_result

    - name: Summarize available updates
      ansible.builtin.debug:
        msg:
          - "Found {{ search_result.found_update_count | default(0) }} updates"
          - "Titles: {{ (search_result.updates | default([])) | map(attribute='title') | list }}"

    - name: Expose search summary in job output (AAP set_stats)
      ansible.builtin.set_stats:
        data:
          windows_updates_found: "{{ search_result.found_update_count | default(0) }}"
          windows_updates_titles: "{{ (search_result.updates | default([])) | map(attribute='title') | list }}"

    # - name: Install updates (multiple passes with safe reboots)
    #   ansible.windows.win_updates:
    #     state: installed
    #     category_names: "{{ update_categories }}"
    #     reboot: "{{ (not skip_reboot) | bool }}"
    #     log_path: "{{ win_updates_log_path }}"
    #     reboot_timeout: 3600
    #   register: install_result
    #   until: install_result.installed_update_count | default(0) == 0 and (install_result.reboot_required | default(false)) == false
    #   retries: "{{ install_passes }}"
    #   delay: 30

    # - name: Final status
    #   ansible.builtin.debug:
    #     msg:
    #       - "Installed this pass: {{ install_result.installed_update_count | default(0) }}"
    #       - "Reboot required now? {{ install_result.reboot_required | default(false) }}"
    #       - "Log: {{ win_updates_log_path }}"
